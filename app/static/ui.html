<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CV Score — Dashboard (Uploads)</title>
  <style>
    :root { --bg:#0b1020; --card:#111734; --muted:#a3acc3; --text:#e7ecff; --accent:#7c9cff; --ok:#10b981; --err:#ef4444; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -10%, #172042 0, transparent 70%), radial-gradient(1400px 800px at 120% -30%, #1a2650 0, transparent 60%), var(--bg); color:var(--text); font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid #223058;background:rgba(0,0,0,0.2);backdrop-filter: blur(6px); position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:28px;height:28px;background:linear-gradient(135deg,#7c9cff,#a78bfa);border-radius:8px;box-shadow:0 0 0 2px #7c9cff22, 0 10px 30px #7c9cff33}
    .subtitle{color:var(--muted);font-size:12px}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns: 1fr 1fr; gap:16px}
    .card{background:linear-gradient(180deg,#141a34 0,#0f1530 100%); border:1px solid #223058; border-radius:16px; padding:16px; box-shadow:0 10px 30px #00000033}
    h2{margin:0 0 10px 0;font-size:18px}
    label{display:block;margin:10px 0 6px 2px; color:#c9d4ff; font-size:14px}
    input[type=text], textarea{width:100%;background:#0a0f24;border:1px solid #223058;border-radius:12px;color:var(--text);padding:10px 12px;outline:none}
    textarea{min-height:100px;resize:vertical;line-height:1.45}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button{appearance:none;background:linear-gradient(180deg,#1a2a6b,#16255a);border:1px solid #2c3f83;color:var(--text);border-radius:12px;padding:10px 14px;cursor:pointer;transition:transform .05s ease, box-shadow .2s ease}
    button:hover{transform:translateY(-1px); box-shadow:0 8px 24px #5f77ff33}
    button.secondary{background:linear-gradient(180deg,#19223f,#121a36);border-color:#2a355f}
    .status{font-size:12px;color:var(--muted);margin-left:8px;align-self:center}
    .muted{color:var(--muted)} .small{font-size:12px}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{padding:3px 8px;border-radius:999px;background:#17224a;border:1px solid #2a3a78;color:#cfe0ff;font-size:12px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid #223058;text-align:left;vertical-align:top;font-size:14px}
    th{color:#cbd5ff}
    .bar{height:10px;background:#1b2447;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,#7c9cff,#22d3ee);}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#17224a;border:1px solid #2a3a78;color:#cfe0ff;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div>CV Score <span class="chip">Uploads</span></div>
        <div class="subtitle">Create Job → Create Candidate → Paste or Upload CV → Match</div>
      </div>
    </div>
    <div class="small muted">Service: <code id="dbg_url"></code></div>
  </header>

  <div class="container">
    <div class="grid">
      <section class="card">
        <h2>1) Job setup</h2>
        <div class="row">
          <div>
            <label>Job title</label>
            <input id="job_title" type="text" placeholder="data engineer" />
          </div>
          <div>
            <label>Required skills (comma)</label>
            <input id="job_req" type="text" placeholder="etl, airflow, spark" />
          </div>
        </div>
        <label>Preferred skills (comma)</label>
        <input id="job_pref" type="text" placeholder="databricks, delta lake" />
        <label>Job description</label>
        <textarea id="job_text" placeholder="We need ETL, Airflow, Spark, Databricks, Delta Lake"></textarea>
        <div class="toolbar">
          <button onclick="createJob()">Create Job</button>
          <span id="job_status" class="status"></span>
        </div>
        <div class="small muted" style="margin-top:6px">Job ID: <code id="dbg_job">—</code></div>
      </section>

      <section class="card">
        <h2>2) Candidates & CVs</h2>
        <div class="row">
          <div>
            <label>External ref (optional)</label>
            <input id="cand_ref" type="text" placeholder="cand-001" />
          </div>
          <div>
            <label>Anonymized?</label>
            <input id="cand_anon" type="checkbox" />
          </div>
        </div>
        <div class="toolbar">
          <button onclick="createCandidate()">Create Candidate</button>
          <span id="cand_status" class="status"></span>
        </div>
        <label>CV text (optional)</label>
        <textarea id="cv_text" placeholder="- Built ETL in Airflow...
- Migrated to Spark on Databricks; cut runtime 41%"></textarea>
        <div class="toolbar">
          <button class="secondary" onclick="addCV()">Attach CV text</button>
          <span id="cv_status" class="status"></span>
        </div>

        <div style="margin-top:12px;border-top:1px dashed #2a3a78;padding-top:12px">
          <label>Upload PDF/DOCX</label>
          <input id="cv_file" type="file" accept=".pdf,.docx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
          <div class="toolbar">
            <button class="secondary" onclick="uploadFile()">Upload file</button>
            <span id="file_status" class="status"></span>
          </div>
        </div>
      </section>
    </div>

    <section class="card">
      <h2>3) Match & Results</h2>
      <div class="toolbar">
        <button onclick="runMatch()">Run match for Job</button>
        <button class="secondary" onclick="getResults()">Refresh Top-5</button>
        <span id="run_status" class="status"></span>
      </div>
      <div id="results"></div>
      <div class="small muted" style="margin-top:6px">Run ID: <code id="dbg_run">—</code></div>
    </section>
  </div>

<script>
let jobId = localStorage.getItem("jobId") || null;
let candidateId = localStorage.getItem("candidateId") || null;
let runId = localStorage.getItem("runId") || null;
document.getElementById("dbg_url").textContent = location.origin;

const el = (id)=>document.getElementById(id);
const setText = (id, txt, kind="") => { const n=el(id); if(n){ n.textContent = txt||""; n.className = "status " + kind; } }
const dbg = () => { el("dbg_job").textContent = jobId || "—"; el("dbg_run").textContent = runId || "—"; }
function arrFromComma(s){ return (s||"").split(",").map(v=>v.trim()).filter(Boolean); }
function pct(n){ return Math.max(0, Math.min(100, Math.round((n||0)*1000)/10)); }
function escapeHtml(s){ return (s||"").replace(/[&<>'\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"\'":'&#39;','"':'&quot;'}[c])); }

async function createJob(){
  setText("job_status","Creating job…");
  const payload = {
    title: el("job_title").value || "data engineer",
    jd_text: el("job_text").value || "We need ETL, Airflow, Spark, Databricks, Delta Lake",
    jd_required_skills: arrFromComma(el("job_req").value || "etl, airflow, spark"),
    jd_preferred_skills: arrFromComma(el("job_pref").value || "databricks, delta lake")
  };
  const r = await fetch("/jobs/", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
  if(!r.ok){ setText("job_status","Error creating job","err"); return; }
  const j = await r.json();
  jobId = j.id; localStorage.setItem("jobId", jobId);
  setText("job_status","Job created ✓","ok"); dbg();
}

async function createCandidate(){
  setText("cand_status","Creating candidate…");
  const payload = { external_ref: el("cand_ref").value || null, anonymized: el("cand_anon").checked || false };
  const r = await fetch("/candidates/", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
  if(!r.ok){ setText("cand_status","Error creating candidate","err"); return; }
  const j = await r.json();
  candidateId = j.id; localStorage.setItem("candidateId", candidateId);
  setText("cand_status","Candidate created ✓","ok");
}

async function addCV(){
  if(!candidateId){ setText("cv_status","Create a candidate first","err"); return; }
  setText("cv_status","Attaching CV text…");
  const payload = { type:"cv", text_extracted: el("cv_text").value || "", parsed_json: null };
  const r = await fetch(`/candidates/${candidateId}/documents`, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
  if(!r.ok){ setText("cv_status","Error attaching CV","err"); return; }
  setText("cv_status","CV text attached ✓","ok");
}

async function uploadFile(){
  if(!candidateId){ setText("file_status","Create a candidate first","err"); return; }
  const file = el("cv_file").files[0];
  if(!file){ setText("file_status","Choose a PDF or DOCX","err"); return; }
  const form = new FormData();
  form.append("file", file);
  setText("file_status","Uploading…");
  const r = await fetch(`/candidates/${candidateId}/upload`, { method:"POST", body: form });
  if(!r.ok){
    const msg = await r.text();
    setText("file_status", "Upload failed: " + (msg || r.status), "err");
    return;
  }
  setText("file_status","File uploaded ✓","ok");
}

async function runMatch(){
  if(!jobId){ setText("run_status","Create a job first","err"); return; }
  setText("run_status","Running match…");
  const r = await fetch(`/match/${jobId}/run`, {method:"POST"});
  if(!r.ok){ setText("run_status","Error running match","err"); return; }
  const j = await r.json();
  runId = j.id; localStorage.setItem("runId", runId);
  setText("run_status","Run created ✓","ok"); dbg();
  await getResults();
}

async function getResults(){
  if(!runId){ setText("run_status","Run the match first","err"); return; }
  const r = await fetch(`/match/${runId}/results?top_n=5`);
  if(!r.ok){ setText("run_status","Error loading results","err"); return; }
  const j = await r.json();
  renderResults(j.results || []);
  setText("run_status","Top-5 updated ✓","ok");
}

function renderResults(rows){
  const box = document.getElementById("results");
  if(!rows.length){ box.innerHTML = `<div class="muted">No results yet.</div>`; return; }
  const trs = rows.map(r => {
    const score = pct(r.total_score);
    const subs = Object.entries(r.subscores||{}).map(([k,v]) => `<span class="chip">${k}: ${pct(v)}%</span>`).join(" ");
    const hb = (r.hard_blockers||[]).map(x=>`<span class="chip" style="border-color:#7f1d1d;color:#fecaca;background:#3b0f0f;">${escapeHtml(x)}</span>`).join(" ");
    const sugg = r.suggestions || {};
    const skills = (sugg.skills_to_surface||[]).map(s=>`<span class="chip">${escapeHtml(s)}</span>`).join(" ");
    const rewrites = (sugg.bullets_to_rewrite||[]).slice(0,2).map(o=>`<div class="small"><div class="muted">• ${escapeHtml(o.original||"")}</div><div>↳ ${escapeHtml(o.rewrite||"")}</div></div>`).join("");
    return `<tr>
      <td style="width:30%">
        <div class="badge">Candidate</div>
        <div><code>${r.candidate_id}</code></div>
        <div class="small muted">Rank #${r.rank}</div>
      </td>
      <td style="width:30%">
        <div class="bar"><i style="width:${score}%"></i></div>
        <div class="small muted" style="margin-top:6px">${score}% total</div>
        <div class="chips" style="margin-top:6px">${subs}</div>
        <div class="chips" style="margin-top:6px">${hb}</div>
      </td>
      <td>
        <div class="small muted">Skills to surface</div>
        <div class="chips">${skills || "<span class='muted small'>(none)</span>"}</div>
        <div class="small muted" style="margin-top:8px">Rewrites</div>
        <div>${rewrites || "<span class='muted small'>(none)</span>"}</div>
      </td>
    </tr>`;
  }).join("");

  box.innerHTML = `<table>
    <thead><tr><th>Candidate</th><th>Score</th><th>Suggestions</th></tr></thead>
    <tbody>${trs}</tbody>
  </table>`;
}

dbg();
</script>
</body>
</html>
